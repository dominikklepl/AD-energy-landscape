---
title: "pMEM fitting"
author: "Dominik Klepl"
date: "6/9/2020"
output:
  pdf_document: default
  html_document: default
---

Libraries
```{r}
#import custom functions
source("scripts/pMEM.R")
```


Read testing data
```{r}
#data = read.table("testdata.dat")
#data = data[,sample(1:ncol(data),1000),]

file = "data/clean/R38-16_HC_EC.RData"
load(file)
data = t(data)[14:23,]
```

Threshold the data
```{r}
binarized = binarize(data)
```

Check number of unique states
```{r}
#how many combinations are possible?
2^nrow(binarized) 

#unite to form binary states

unique = t(binarized) %>%
  as.data.frame() %>%
  unite("state", sep = "") %>%
  group_by(state) %>%
  summarise(count = n())

ggplot(unique, aes(count))+
  geom_histogram(binwidth = 10)+
  theme_few()+
  labs(x ="Occurences of state")

pastecs::stat.desc(unique$count)
```

## Fit pMEM with pseudo-likelihood

```{r}
param = pMEM_PL(binarized)

#compare pMEM parameters with Pearson's correlation scores
corrplot::corrplot(param$J, method = "color")
corrplot::corrplot(cor(t(data)), method="color")
```

Compare empirical and predicted probabilities
```{r}
probs_emp = get_empirical_prob(binarized)
probs = get_probability(param)
```


Using regression and $R^2$
```{r}
get_R2(probs_emp, probs)
```

+visually
```{r}
data.frame(empirical = probs_emp, predicted = probs) %>%
  ggplot(aes(predicted, empirical))+
  geom_point()+
  theme_few()
```




Test
Sanity check - higher probability means lower energy.
```{r}
data.frame(Probability = get_probability(param),Energy = get_energy(param)) %>%
  ggplot(aes(Probability, Energy))+
  geom_point()+
  theme_few()
```



```{r}
channels = 15:24
load(file)
data = t(data)
data = data[channels,]
results = run_pMEM(data)
```


```{r}
files = list.files("data/clean", full.names = T)
#keep only 10 channels
#for now random
channels = 15:24

for (i in 1:length(files)){
  load(files[i])
  data = t(data)
  data = data[channels,]
  results = run_pMEM(data)
  
  save_to = paste0("data/pMEM/",strsplit(files[i],"/")[[1]][3])
  save(results, file = save_to)
}
```


