---
title: "Energy landscape analysis"
author: "Dominik Klepl"
date: "6/18/2020"
output:
  pdf_document: default
  html_document: default
---

```{r}
library(ggplot2)
library(ggthemes)
source("scripts/ELA.R")
```


Load one pMEM result
```{r}
load("data/pMEM/R38-16_HC_EC.RData")
```

Compute energy of all states. Get vector of all states. Merge them in a dataframe. I'll be using binary notation of states (1/0) instead of 1/-1 for better readability.
```{r}
states_energy = get_state_energy(results$parameters)
```

## Energy landscape network

Construct adjacency matrix - states are connected if hamming distance = 1.
```{r}
adj = get_adjacency(states_energy$state)
```


## Find local minima
```{r}
minima = find_minima(adj, states_energy)
```

### Mean energy difference between global minimum and local minima
```{r}
mean_energy_difference(minima)
```


## Estimate basin size
```{r}
basin_df = basin_size_estimator(adj, states_energy)

basin_df$membership %>% 
  group_by(basin) %>%
  summarise(count = n()) %>%
  ggplot(aes(basin, count, fill=basin))+
  geom_col()+
  theme_few()+
  scale_fill_tableau()+
  guides(fill=F)
```

## Visualize basins
```{r}
(basin_plot = plot_basin(basin_df))
ggsave("figures/basin_plot.png",basin_plot, width = 10, height = 8)
```


## Estimate energy barriers between minima
```{r include=F}
barrier_df = find_energy_barrier(minima,states_energy,adj)
```

### Construct disconnectivity graph
```{r}
p_disc = plot_disconnectivity(barrier_df)
p_disc

ggsave("figures/disconnectivity.png", p_disc)
```

## Construct network of local minima and transfer states
```{r}
L = construct_LMTS(barrier_df)

plot_LMTS(L$graph)

#just for fun
L$graph %>%
  activate(nodes) %>%
  mutate(degree = centrality_degree()) %>%
  select(name, degree) %>%
  as_tibble() %>%
  ggplot(aes(x=degree)) +
  geom_histogram(binwidth = 0.2)+
  theme_few()

ggsave("figures/LMTS.png", plot, width = 7, height = 7)
```


## Simulate duration in basin - Metropolis-Hastings MCMC

Start at random
Get neighbours
Select one of the N neigbours with Pr = 1/N
Get energy of current state and proposed state
If E(current)<E(proposed) - move with probability of exp(E(current)-E(proposed))
Else (i.e. E(current)>E(proposed)) - move with probability of 1

Simulate 10 seconds of transitions (10*2000Hz = 20000) + 2000 for warm-up
```{r}
x = simulate_transitions(2e4, adj, states_energy)

duration = data.frame(state = x) %>%
  left_join(basin_df$membership) %>%
  group_by(basin) %>%
  summarise(duration = n()) %>%
  mutate(duration = duration/2000)
  
ggplot(duration, aes(basin, duration, fill=basin))+
  geom_col()+
  theme_few()+
  scale_fill_tableau()+
  labs(x = "Local minimum",
       y = "seconds")+
  guides(fill=F)
```

Run all energy landscape analysis, extract features and produce plots
```{r}
file = "data/pMEM/R38-16_HC_EC.RData"

r = analyze_energy_landscape(file)

library(patchwork)
A = r$plots$basins
B = r$plots$disconnectivity_graph
C = r$plots$LMTS

plot_collected = (A/C)|B

```


Run for all
```{r}
#selections = c("left", "post", "R", "right")
selections = c("R")
#bands = c("alpha", "beta", "delta", "full", "gamma", "theta")
bands = c("gamma")

for (s in selections){
  print(s)
  for (b in bands){
    folder = paste0("data/pMEM_", s, "/", b)
    files = list.files(folder, full.names = T)
    print(b)
    results = data.frame()
    for (i in 1:length(files)){
      result = analyze_energy_landscape(files[i])
      results = rbind(results, result)
    }
    save_to = paste0("results/ELA/", s, "_", b, ".csv")
    readr::write_csv(results, save_to)
  }
}
```

