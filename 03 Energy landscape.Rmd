---
title: "Energy landscape analysis"
author: "Dominik Klepl"
date: "6/18/2020"
output:
  pdf_document: default
  html_document: default
---

```{r}
library(ggplot2)
library(ggthemes)
source("scripts/ELA.R")
```


Load one pMEM result
```{r}
load("data/pMEM/R38-16_HC_EC.RData")
```

Compute energy of all states. Get vector of all states. Merge them in a dataframe. I'll be using binary notation of states (1/0) instead of 1/-1 for better readability.
```{r}
states_energy = get_state_energy(results$parameters)
```

## Energy landscape network

Construct adjacency matrix - states are connected if hamming distance = 1.
```{r}
adj = get_adjacency(states_energy$state)
```


## Find local minima
```{r}
minima = find_minima(adj, states_energy)
```

## Estimate basin size
```{r}
basin_df = basin_size_estimator(adj, states_energy)

basin_df$membership %>% 
  group_by(basin) %>%
  summarise(count = n()) %>%
  ggplot(aes(basin, count, fill=basin))+
  geom_col()+
  theme_few()+
  scale_fill_tableau()+
  guides(fill=F)
```

## Visualize basins
```{r}
(basin_plot = plot_basin(basin_df))
ggsave("basin_plot.png",basin_plot, width = 10, height = 8)
```


## Estimate energy barriers between minima
```{r include=F}
barrier_df = find_energy_barrier(minima,states_energy,adj)
```

### Construct disconnectivity graph
```{r}
plot_disconnectivity(barrier_df)
```

## Simulate duration in basin - Metropolis-Hastings/MCMC variant

Start at random
Get neighbours
Select one of the N neigbours with Pr = 1/N
Get energy of current state and proposed state
If E(current)<E(proposed) - move with probability of exp(E(current)-E(proposed))
Else (i.e. E(current)>E(proposed)) - move with probability of 1

Simulate 10 seconds of transitions (10*2000Hz = 20000) + 2000 for warm-up
```{r}
x = simulate_transitions(2e4, adj, states_energy)

duration = data.frame(state = x) %>%
  left_join(basin_df$membership) %>%
  group_by(basin) %>%
  summarise(duration = n()) %>%
  mutate(duration = duration/2000)
  
ggplot(duration, aes(basin, duration, fill=basin))+
  geom_col()+
  theme_few()+
  scale_fill_tableau()+
  labs(x = NULL,
       y = "seconds")+
  guides(fill=guide_legend(title = "Basin of locmin"))

x = sapply(x, BinToDec)
plot(x, type = "l")
```









Run for all
```{r}
# files = list.files("data/pMEM", full.names = T)
# 
# n = rep(NA,length(files))
# diag = rep(NA,length(files))
# cond = rep(NA,length(files))
# for (i in 1:length(files)){
#   load(files[i])
#   states_energy = get_state_energy(results$parameters)
#   adj = get_adjacency(states_energy$state)
#   m = find_minima(adj, states_energy)
#   n[i] = nrow(m)
#   diag[i] = strsplit(files[i],"_")[[1]][2]
#   cond[i] = strsplit(strsplit(files[i],"_")[[1]][3],"\\.")[[1]][1]
# }
# 
# data.frame(n, diag,cond) %>% group_by(diag,cond) %>% summarise(avg = mean(n))
# data.frame(n, diag,cond) %>% group_by(cond) %>% summarise(avg = mean(n))
```

