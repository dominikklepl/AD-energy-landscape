---
title: "Energy landscape analysis"
author: "Dominik Klepl"
date: "6/18/2020"
output:
  pdf_document: default
  html_document: default
---

```{r}
library(ggplot2)
library(ggthemes)
source("scripts/ELA.R")
```


Load one pMEM result
```{r}
load("data/pMEM/R38-16_HC_EC.RData")
```

Compute energy of all states. Get vector of all states. Merge them in a dataframe. I'll be using binary notation of states (1/0) instead of 1/-1 for better readability.
```{r}
states_energy = get_state_energy(results$parameters)
```

## Energy landscape network

Construct adjacency matrix - states are connected if hamming distance = 1.
```{r}
adj = get_adjacency(states_energy$state)
```


## Find local minima
```{r}
minima = find_minima(adj, states_energy)
```

## Estimate basin size
```{r}
basin_df = basin_size_estimator(adj, states_energy)

basin_df$membership %>% 
  group_by(basin) %>%
  summarise(count = n()) %>%
  ggplot(aes(basin, count, fill=basin))+
  geom_col()+
  theme_few()+
  scale_fill_tableau()+
  guides(fill=F)
```

## Visualize basins
```{r}
(basin_plot = plot_basin(basin_df))
ggsave("figures/basin_plot.png",basin_plot, width = 10, height = 8)
```


## Estimate energy barriers between minima
```{r include=F}
barrier_df = find_energy_barrier(minima,states_energy,adj)
```

### Construct disconnectivity graph
```{r}
p_disc = plot_disconnectivity(barrier_df)
p_disc

ggsave("figures/disconnectivity.png", p_disc)
```

## Construct network of local minima and transfer states
```{r}
united = barrier_df %>% unite("pair", min1:min2)
mins = unique(barrier_df$min1)
find = gtools::combinations(length(mins), 2, mins) %>% as.data.frame() %>% unite("pair", 1:2)
idx = united$pair %in% find$pair

LMTS_construct = barrier_df[idx,]
LMTS = matrix(NA, 0, 5)
saddles = unique(LMTS_construct$saddle) %>% sapply(BinToDec)

for (i in 1:nrow(LMTS_construct)){
  row = LMTS_construct[i,]
  barrier = row$barrier
  
  #get reduced network
  states_reduced = states_energy[states_energy$energy<=barrier,]
  A_reduced = get_adjacency(states_reduced$state)
  network_reduced = igraph::graph_from_adjacency_matrix(A_reduced, "undirected")
  transfer = igraph::shortest_paths(network_reduced, from = row$min1, to = row$min2) $vpath[[1]]$name
  
  sub = igraph::induced_subgraph(network_reduced, transfer)
  edgelist = igraph::as_edgelist(sub)
  edgelist = cbind(edgelist,
                   rep(row$min1, nrow(edgelist)), 
                   rep(row$min2, nrow(edgelist)),
                   rep(barrier, nrow(edgelist)))
  
  LMTS = rbind(LMTS, edgelist)
}

LMTS[,1] = sapply(LMTS[,1], BinToDec)
LMTS[,2] = sapply(LMTS[,2], BinToDec)
LMTS[,3] = sapply(LMTS[,3], BinToDec)
LMTS[,4] = sapply(LMTS[,4], BinToDec)

LMTS = as.data.frame(LMTS) %>% unite("Path", 3:4, sep = "-")
colnames(LMTS)[c(1:2,4)] = c("from","to","weight")
LMTS$weight = 1/as.numeric(LMTS$weight)

tidy = as_tbl_graph(LMTS, directed = T) 

mins = sapply(mins,BinToDec)
tidy = tidy %>% activate(nodes) %>%
  mutate(Node_type = case_when(name %in% mins ~ "2 Minimum",
                         name %in% saddles ~ "3 Saddle",
                         T ~ "1 Node"))
  
plot = tidy %>%
    ggraph()+
    geom_edge_fan(aes(edge_color=Path))+
    geom_node_point(aes(color=Node_type),size=5)+
    scale_color_tableau()+
    guides(color=guide_legend(title = "Node type"),
           edge_width = F)+
    theme_few()
plot

ggsave("figures/LMTS.png", plot)
```


## Simulate duration in basin - Metropolis-Hastings MCMC

Start at random
Get neighbours
Select one of the N neigbours with Pr = 1/N
Get energy of current state and proposed state
If E(current)<E(proposed) - move with probability of exp(E(current)-E(proposed))
Else (i.e. E(current)>E(proposed)) - move with probability of 1

Simulate 10 seconds of transitions (10*2000Hz = 20000) + 2000 for warm-up
```{r}
x = simulate_transitions(2e4, adj, states_energy)

duration = data.frame(state = x) %>%
  left_join(basin_df$membership) %>%
  group_by(basin) %>%
  summarise(duration = n()) %>%
  mutate(duration = duration/2000)
  
ggplot(duration, aes(basin, duration, fill=basin))+
  geom_col()+
  theme_few()+
  scale_fill_tableau()+
  labs(x = NULL,
       y = "seconds")+
  guides(fill=guide_legend(title = "Basin of locmin"))

x = sapply(x, BinToDec)
plot(x, type = "l")
```









Run for all
```{r}
# files = list.files("data/pMEM", full.names = T)
# 
# n = rep(NA,length(files))
# diag = rep(NA,length(files))
# cond = rep(NA,length(files))
# for (i in 1:length(files)){
#   load(files[i])
#   states_energy = get_state_energy(results$parameters)
#   adj = get_adjacency(states_energy$state)
#   m = find_minima(adj, states_energy)
#   n[i] = nrow(m)
#   diag[i] = strsplit(files[i],"_")[[1]][2]
#   cond[i] = strsplit(strsplit(files[i],"_")[[1]][3],"\\.")[[1]][1]
# }
# 
# data.frame(n, diag,cond) %>% group_by(diag,cond) %>% summarise(avg = mean(n))
# data.frame(n, diag,cond) %>% group_by(cond) %>% summarise(avg = mean(n))
```

