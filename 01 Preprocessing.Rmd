---
title: "01 Preprocessing"
author: "Dominik Klepl"
date: "6/11/2020"
output:
  pdf_document: default
  html_document: default
---
 
```{r}
#load custom functions
source("scripts/preprocess.R")
```

## Load data and extract info from filename 
```{r}
files = list.files("data", full.names = T, recursive = T)
d = load_data(files[2])
attr(d,"info")
```

## Inspect a few signals
```{r}
ggplot(d, aes(Time,F8_F4))+
  geom_line()+
  theme_few()

ggplot(d, aes(Time,O1_O2))+
  geom_line()+
  theme_few()

ggplot(d, aes(Time,P3_O1))+
  geom_line()+
  theme_few()
```

## Inverse FFT filtering

Test filters
```{r}
#notch filter - remove 50Hz noise
notch = filter_notch(d$F8_F4)
data.frame(Time = d$Time, Signal = notch) %>%
  ggplot(aes(Time,Signal))+
  geom_line()+
  theme_few()

#bandpass - remove everything above 100Hz
highpass = filter_bandpass(notch, upper = 100)
data.frame(Time = d$Time, Signal = highpass) %>%
  ggplot(aes(Time,Signal))+
  geom_line()+
  theme_few()

#bandpass - get alpha waves - 8-15 Hz
alpha = filter_bandpass(highpass, lower = 8, upper = 15)
data.frame(Time = d$Time, Signal = alpha) %>%
  ggplot(aes(Time,Signal))+
  geom_line()+
  theme_few()

#apply filters to whole dataset
tic("Notch filter")
d[,-1] = apply(d[,-1], 2, filter_notch)
toc()

tic("Highpass filter")
d[,-1] = apply(d[,-1], 2, filter_bandpass, upper=50)
toc()

#check that filtering was successful with fourier transform
eegfft(highpass,2000) %>%
  ggplot(aes(frequency,strength))+
  geom_point()+
  theme_few()+
  xlim(c(0,200))
```

## Plot head and electrodes with ggplot
Test plotting head and randomly color channels
```{r}
locs = get_channel_loc()
locs$color = rnorm(nrow(locs),0,0.5)

geom_head()+
  geom_point(data=locs, aes(x,y,color=color),size=8)
```

## Independent component analysis (ICA)
### ICA with FastICA package

### Run ICA on all channels together

Run for all participants and conditions
```{r}
locs = get_channel_loc()

for (i in 1:length(files)){
  data = preprocess(files[i])
  result = run_full_ica(data, locations = locs)
  
  filename = paste0("ICA/full/",attr(data,"info")[1],"_",attr(data,"info")[2],attr(data,"info")[3],".png")
  ggsave(filename, result, width = 7,height = 12)
}
```

### Run ICA on frontal and posterior channels separately

Divide channels
```{r}
channel_grouped = locs
channel_grouped$labs = rownames(channel_grouped)
channel_grouped$group = c(rep("front",11),rep("post",12))

geom_head()+
  geom_label(data=channel_grouped, aes(x,y,label=labs,fill=group))

#create mask for selecting frontal and posterior channels
front_chan = channel_grouped$labs[channel_grouped$group=="front"]
post_chan = channel_grouped$labs[channel_grouped$group=="post"]
```

Run ICA
```{r}
locs = get_channel_loc()

for (i in 1:length(files)){
  data = preprocess(files[i])
  result_front = run_half_ica(data, ncomp=8, locations = locs, group = front_chan)
  
  filename = paste0("ICA/front/",attr(data,"info")[1],"_",attr(data,"info")[2],attr(data,"info")[3],".png")
  ggsave(filename, result_front, width = 7,height = 12)
  
  result_post = run_half_ica(data, ncomp=9, locations = locs, group = post_chan)
  
  filename = paste0("ICA/post/",attr(data,"info")[1],"_",attr(data,"info")[2],attr(data,"info")[3],".png")
  ggsave(filename, result_post, width = 7,height = 12)
}
```

## Final pipeline
```{r}
files = list.files("data/raw", full.names = T, recursive = T)

for (i in 1:length(files)){
  data = preprocess(files[i])

  new_name = paste(attr(data,"info")[1],attr(data,"info")[2],attr(data,"info")[3],sep = "_")
  save_to = paste0("data/clean/",new_name,".RData")
  
  save(data,file=save_to)
}
```

