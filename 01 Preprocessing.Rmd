---
title: "01 Preprocessing"
author: "Dominik Klepl"
date: "6/11/2020"
output:
  pdf_document: default
  html_document: default
---
 
```{r}
#load custom functions
source("scripts/preprocess.R")
```

## Load data and extract info from filename 
```{r}
files = list.files("data/raw", full.names = T, recursive = T)
d = load_data(files[8])
attr(d,"info")
```

## Inspect a few signals
```{r}
ggplot(d, aes(Time,F8_F4))+
  geom_line()+
  theme_few()

ggplot(d, aes(Time,O1_O2))+
  geom_line()+
  theme_few()

ggplot(d, aes(Time,P3_O1))+
  geom_line()+
  theme_few()
```

## Inverse FFT filtering

Test filters
```{r}
#notch filter - remove 50Hz noise
notch = filter_notch(d$F8_F4)
data.frame(Time = d$Time, Signal = notch) %>%
  ggplot(aes(Time,Signal))+
  geom_line()+
  theme_few()

#bandpass - remove everything above 100Hz
highpass = filter_bandpass(notch, upper = 100)
data.frame(Time = d$Time, Signal = highpass) %>%
  ggplot(aes(Time,Signal))+
  geom_line()+
  theme_few()

#bandpass - get alpha waves - 8-15 Hz
alpha = filter_bandpass(highpass, lower = 8, upper = 15)
data.frame(Time = d$Time, Signal = alpha) %>%
  ggplot(aes(Time,Signal))+
  geom_line()+
  theme_few()

#apply filters to whole dataset
tic("Notch filter")
d[,-1] = apply(d[,-1], 2, filter_notch)
toc()

tic("Highpass filter")
d[,-1] = apply(d[,-1], 2, filter_bandpass, upper=50)
toc()

#check that filtering was successful with fourier transform
eegfft(highpass,2000) %>%
  ggplot(aes(frequency,strength))+
  geom_point()+
  theme_few()+
  xlim(c(0,200))
```

## Plot head and electrodes with ggplot
Test plotting head and randomly color channels
```{r}
locs = get_channel_loc()
locs$color = rnorm(nrow(locs),0,0.5)

geom_head()+
  geom_point(data=locs, aes(x,y,color=color),size=8)
```

## Independent component analysis (ICA)
### ICA with FastICA package

### Run ICA on all channels together

Run for all participants and conditions
```{r}
locs = get_channel_loc()

for (i in 1:length(files)){
  data = preprocess(files[i])
  result = run_full_ica(data, locations = locs)
  
  filename = paste0("ICA/full/",attr(data,"info")[1],"_",attr(data,"info")[2],attr(data,"info")[3],".png")
  ggsave(filename, result, width = 7,height = 12)
}
```

### Run ICA on frontal and posterior channels separately

Divide channels
```{r}
channel_grouped = locs
channel_grouped$labs = rownames(channel_grouped)
channel_grouped$group = c(rep("front",11),rep("post",12))

geom_head()+
  geom_label(data=channel_grouped, aes(x,y,label=labs,fill=group))

#create mask for selecting frontal and posterior channels
front_chan = channel_grouped$labs[channel_grouped$group=="front"]
post_chan = channel_grouped$labs[channel_grouped$group=="post"]
```

Run ICA
```{r}
locs = get_channel_loc()

for (i in 1:length(files)){
  data = preprocess(files[i])
  result_front = run_half_ica(data, ncomp=8, locations = locs, group = front_chan)
  
  filename = paste0("ICA/front/",attr(data,"info")[1],"_",attr(data,"info")[2],attr(data,"info")[3],".png")
  ggsave(filename, result_front, width = 7,height = 12)
  
  result_post = run_half_ica(data, ncomp=9, locations = locs, group = post_chan)
  
  filename = paste0("ICA/post/",attr(data,"info")[1],"_",attr(data,"info")[2],attr(data,"info")[3],".png")
  ggsave(filename, result_post, width = 7,height = 12)
}
```

# Final pipeline

## Plot montage
```{r}
names = c("F8_F4","F7_F3","F4_C4","F3_C3","F4_FZ","F3_FZ","FZ_CZ","T4_C4","T3_C3","C4_CZ","C3_CZ","CZ_PZ","C4_P4","C3_P3","T4_T6","T3_T5","P4_PZ","P3_PZ","T6_O2","T5_O1","P4_O2","P3_O1","O1_O2")

#get positions of individual channels
data(eegcoord)
pair_locs = matrix(NA, length(names)*2, 3)

single_channels = sapply(names, strsplit, split="_") %>% unlist() %>% unique()
names(single_channels) = NULL

single_df = eegcoord[single_channels, 4:5]
colnames(single_df) = c("x","y")
single_df$channel = single_channels

single_df[single_df$channel=="T3",1:2] = eegcoord["T7",4:5]
single_df[single_df$channel=="T4",1:2] = eegcoord["T8",4:5]
single_df[single_df$channel=="T5",1:2] = eegcoord["P7",4:5]
single_df[single_df$channel=="T6",1:2] = eegcoord["P8",4:5]

geom_head()+
  geom_text(data=single_df, aes(x,y, label=channel))+
  geom_point(data=single_df, aes(x,y), shape=1, size=9)

#construct lines between channel pairs
channel_loc = matrix(0, length(names),5)
colnames(channel_loc) = c("x_start", "y_start", "x_end","y_end", "channel")
channel_loc[,"channel"] = names

for(i in 1:length(names)){
  pair_name = strsplit(names[i],"_")[[1]]
  
  channel_loc[i,1:2] = as.numeric(single_df[single_df$channel==pair_name[1],1:2])
  channel_loc[i,3:4] = as.numeric(single_df[single_df$channel==pair_name[2],1:2])
}

channel_loc = as.data.frame(channel_loc)

channel_loc$x_start = as.numeric(channel_loc$x_start)
channel_loc$y_start = as.numeric(channel_loc$y_start)
channel_loc$x_end = as.numeric(channel_loc$x_end)
channel_loc$y_end = as.numeric(channel_loc$y_end)

montage = geom_head()+
  geom_text(data=single_df, aes(x,y, label=channel))+
  geom_point(data=single_df, aes(x,y), shape=1, size=9)
```


## Plot selected channels
```{r}
selected_channels = c("P3_O1", "T6_O2", "P4_PZ", "T3_T5", "F3_FZ", "F4_C4")# "T5_O1", "P3_PZ", "C3_P3", "C4_P4")

channel_loc$selected = ifelse(channel_loc$channel %in% selected_channels, "selected", "1")

channels_plot = geom_head()+
  geom_text(data=single_df, aes(x,y, label=channel), size=5.5)+
  geom_point(data=single_df, aes(x,y), shape=1, size=11)+
  geom_segment(data=channel_loc, aes(x = x_start, y = y_start, xend=x_end, yend=y_end, colour=selected), alpha=0.4, size=3, lineend = "butt", linejoin = "bevel")+
  scale_color_manual(breaks = c("Selected"),
                     values = c("grey", "blue"))
channels_plot
  

ggsave("figures/selected_channels.png", channels_plot, width = 7, height = 7)
```


```{r}
files = list.files("data/raw", full.names = T, recursive = T)

#full spectrum
for (i in 1:length(files)){
  data = preprocess(files[i], wave = "full")
  new_name = paste(attr(data,"info")[1],attr(data,"info")[2],attr(data,"info")[3],sep = "_")
  save_to = paste0("data/clean_full/",new_name,".RData")
  save(data,file=save_to)
  print(i)
}

#delta
for (i in 1:length(files)){
  data = preprocess(files[i], wave = "delta")
  new_name = paste(attr(data,"info")[1],attr(data,"info")[2],attr(data,"info")[3],sep = "_")
  save_to = paste0("data/clean_delta/",new_name,".RData")
  save(data,file=save_to)
  print(i)
}

#theta
for (i in 1:length(files)){
  data = preprocess(files[i], wave = "theta")
  new_name = paste(attr(data,"info")[1],attr(data,"info")[2],attr(data,"info")[3],sep = "_")
  save_to = paste0("data/clean_theta/",new_name,".RData")
  save(data,file=save_to)
  print(i)
}

#alpha
for (i in 1:length(files)){
  data = preprocess(files[i], wave = "alpha")
  new_name = paste(attr(data,"info")[1],attr(data,"info")[2],attr(data,"info")[3],sep = "_")
  save_to = paste0("data/clean_alpha/",new_name,".RData")
  save(data,file=save_to)
  print(i)
}

#beta
for (i in 1:length(files)){
  data = preprocess(files[i], wave = "beta")
  new_name = paste(attr(data,"info")[1],attr(data,"info")[2],attr(data,"info")[3],sep = "_")
  save_to = paste0("data/clean_beta/",new_name,".RData")
  save(data,file=save_to)
  print(i)
}

#gamma
for (i in 1:length(files)){
  data = preprocess(files[i], wave = "gamma")
  new_name = paste(attr(data,"info")[1],attr(data,"info")[2],attr(data,"info")[3],sep = "_")
  save_to = paste0("data/clean_gamma/",new_name,".RData")
  save(data,file=save_to)
  print(i)
}
```

